name: åŠ å¯†æ”¿ç­– RSS æ¯æ—¥æŽ¨é€

on:
  # å·²æ”¹ç”¨å¤–éƒ¨ cron æœåŠ¡è§¦å‘ï¼Œé¿å… GitHub Actions schedule å»¶è¿Ÿé—®é¢˜
  # GitHub Actions çš„ schedule åœ¨é«˜å³°æœŸå¯èƒ½å»¶è¿Ÿæ•°å°æ—¶ï¼ˆè§ 2026-01-29 å»¶è¿Ÿ 5 å°æ—¶çš„æƒ…å†µï¼‰
  # schedule:
  #   - cron: '0 0 * * *'

  # æ‰‹åŠ¨è§¦å‘å’Œå¤–éƒ¨ API è§¦å‘ï¼ˆé€šè¿‡ cron-job.org æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00 å‡†æ—¶è§¦å‘ï¼‰
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run æ¨¡å¼ï¼ˆåªæ‰“å°ä¸å‘é€ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      log_level:
        description: 'æ—¥å¿—çº§åˆ«'
        required: false
        default: 'INFO'
        type: choice
        options:
          - 'DEBUG'
          - 'INFO'
          - 'WARNING'
      force_run:
        description: 'å¼ºåˆ¶è¿è¡Œï¼ˆå¿½ç•¥çŠ¶æ€æ–‡ä»¶ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
  # å¯é€‰ï¼šç¿»è¯‘ API
  TRANSLATE_API: ${{ secrets.TRANSLATE_API }}
  DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
  # æ™ºèƒ½æ‘˜è¦ API
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt

      # æ³¨æ„ï¼šstate.json å·²æäº¤åˆ°ä»“åº“ï¼Œcheckout æ—¶è‡ªåŠ¨èŽ·å–æœ€æ–°ç‰ˆæœ¬
      # ä¸å†ä½¿ç”¨ cacheï¼Œé¿å…æ¢å¤æ—§çŠ¶æ€è¦†ç›–ä»“åº“ä¸­çš„æœ€æ–°çŠ¶æ€

      - name: è¿è¡Œ RSS èšåˆå™¨
        id: run_script
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        run: |
          echo "ðŸš€ å¼€å§‹è¿è¡Œ..."
          echo "DRY_RUN: $DRY_RUN"
          echo "LOG_LEVEL: $LOG_LEVEL"
          echo "æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´"
          echo ""

          # å¼ºåˆ¶è¿è¡Œæ—¶åˆ é™¤çŠ¶æ€æ–‡ä»¶
          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "âš ï¸ å¼ºåˆ¶è¿è¡Œæ¨¡å¼ï¼šæ¸…é™¤çŠ¶æ€æ–‡ä»¶"
            rm -f state.json
          fi

          python main.py 2>&1 | tee run_output.log

          # æ£€æŸ¥é€€å‡ºç 
          exit_code=${PIPESTATUS[0]}
          if [ $exit_code -ne 0 ]; then
            echo "âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
            exit $exit_code
          fi

          echo "âœ… æ‰§è¡ŒæˆåŠŸ"

      - name: ä¸Šä¼ æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            run_output.log
            state.json
          retention-days: 7

      - name: æäº¤çŠ¶æ€æ–‡ä»¶
        if: success() && github.event.inputs.dry_run != 'true'
        run: |
          if [ -f state.json ]; then
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            git diff --quiet state.json 2>/dev/null || {
              git config --local user.email "github-actions[bot]@users.noreply.github.com"
              git config --local user.name "github-actions[bot]"
              git add state.json
              git commit -m "chore: æ›´æ–° RSS çŠ¶æ€ [skip ci]

              è¿è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´
              è§¦å‘æ–¹å¼: ${{ github.event_name }}"
              git push
              echo "âœ… çŠ¶æ€æ–‡ä»¶å·²æäº¤"
            }
          fi

      - name: è¾“å‡ºè¿è¡Œæ‘˜è¦
        if: always()
        run: |
          echo "## ðŸ“Š è¿è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry-run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          if [ -f run_output.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ è¿è¡Œæ—¥å¿—ï¼ˆæœ€åŽ 30 è¡Œï¼‰" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 run_output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
